---
id: joining
title: Joining
sidebar_label: Joining
sidebar_position: 6
---

# Join

This page shows how to join two H3 hexagon datasets. This allows merging different datasets together to simplify analysis as each cell contains all the data. 

This is particularly helpful when working with:
- Datasets in different spatial projections
- Sparse datasets like location data
- Datasets of different resolutions or types

![Joining H3 Datasets](/img/tutorials/geospatial/h3/joinging_datasets.png)

### Assumptions

We assume both datasets:
- Use `hex` as the H3 hexagon column name (as with any [ingested H3 dataset](/guide/h3-analytics/raster-to-h3) or vector-to-H3 output)
- Are accessible at the same hex resolution

### Joining logic

We use DuckDB to join the datasets together. 

Using the example from the previous ["Aggregate"](/guide/h3-analytics/aggregations) section, we can join the elevation & crop data layer together.

Elevation dataset ([UDF catalog link](https://www.fused.io/workbench/catalog/copdem_elevation-9c91203e-5411-4a99-8de6-9421c4d90f24)):

|         hex         |   data_avg   |
|---------------------|--------------|
| 599718693687615487  | 14.60947     |
| 599718693687877631  | 31.12178     |
| ...                 | ...          |
| 599718693688401919  | 23.30812     |
| 599718693688664063  | 45.28209     |

Crop Data Layer dataset (filtering to only show corn, i.e. `data_value=1` [UDF Catalog Link](https://www.fused.io/workbench/catalog/reading_cdl_2024_hex_simplified-4deec6b7-bac6-4af6-a67c-ab2a5f594682)):

| hex               | data | area      |
|-------------------|------|-----------|
| 600179630763671551| 1    | 507124    |
| 600179630763671551| 1    | 3537      |
| ...               | ...  | ...       |
| 600181356234760191| 1    | 172089    |
| 600191310987132927| 1    | 801       |

We can join both tables together on the `hex` column:

```python showLineNumbers
@fused.udf
def udf(
    bounds: fused.types.Bounds=[-74.556, 40.4, -73.374, 41.029],
    res: int = 5,
):
    # These are the two datasets coming from the previous "Aggregate" section
    copdem_udf = fused.load('copdem_elevation')
    cdl_udf = fused.load("reading_cdl_2024_hex_simplified")
    
    elevation = copdem_udf(bounds=bounds, res=res)
    cdl = cdl_udf(bounds=bounds, res=res, data_value=1)

    common = fused.load("https://github.com/fusedio/udfs/tree/9a3aae2/public/common/")
    con = common.duckdb_connect()

    qr = f"""
    SELECT 
        e.hex,
        e.data_avg as elevation_data,
        c.data as cdl_data,
        c.total_area as cdl_total_area
    FROM elevation as e
    LEFT JOIN cdl as c
    ON e.hex = c.hex
    """

    return con.execute(qr).df()
```

Returns the following table:

| hex                 | elevation_data | cdl_data | cdl_total_area |
|---------------------|---------------|----------|---------------|
| 599650080954204159  | 289.9432      | 1.0      | 74533290      |
| 599650080954466303  | 257.9233      | 1.0      | 90340230      |
| ...                 | ...           | ...      | ...           |
| 599671053654220799  | 203.5272      | 1.0      | 97844060      |
| 599671261723484159  | 306.1185      | 1.0      | 121949200     |


### Example: Joining env variables

Join multiple H3 layers (CDL, soil, irrigation, GridMET) by hex for analysis:

```python
@fused.udf(cache_max_age=0)
def udf(
    bounds: fused.types.Bounds = [-121.525, 37.70, -120.96, 38.06],
    hex_res: int = 7,
    irr: bool = True,
    state_fips: str = "06",
):
    gdf = get_counties(state_fips)
    bounds = list(gdf.total_bounds)

    df_irr = fused.run("LanID_Irrigation_reader", bounds=bounds, irrigated=irr, hex_res=hex_res, engine="remote")
    df_irr = df_irr[["area", "hex"]].rename(columns={"area": "irr_area"})

    df_crop = fused.run("reading_cdl_2021_hex", bounds=bounds, value=1, res=hex_res, engine="remote")
    df_crop = df_crop[["area", "hex"]].rename(columns={"area": "crop_area"})

    df_soil = fused.run("Soil_gSSURGO_hex_readrer", bounds=bounds, res=hex_res, engine="remote")
    df_soil = df_soil[["data", "taxsubgrp", "cnt", "hex"]].rename(columns={"cnt": "soil_cnt", "data": "mukey"})

    df_gridmet = fused.run("GridMet_Data_Reader", bounds=bounds, hex_res=hex_res, engine="remote")

    df = (
        df_crop.set_index("hex")
        .join(df_soil.set_index("hex"))
        .join(df_irr.set_index("hex"))
        .join(df_gridmet.set_index("hex"))
    )
    return df.reset_index()

@fused.cache
def get_counties(state_fips):
    import geopandas as gpd
    county_gdf = gpd.read_parquet("s3://fused-asset/data/tiger/county/tl_rd22_us_county 1pct.parquet").to_crs("EPSG:4326")
    return county_gdf[county_gdf["GEOID"].str.startswith(f"{int(state_fips):02d}")]
```

Each reader returns a DataFrame with a `hex` column; joining on `hex` gives one row per cell with crop, soil, irrigation, and climate fields.

### More examples

- [Environmental Variable Exploration](/examples/canvas-gallery) canvas: Crop Data Layer, Land Irrigation, Soil Type, Temperature, Precipitation
