---
slug: realtime-data-processing
title: Realtime data processing
---

# Realtime data processing

{/* TODO
- Link to open canvas directly
- Make embeded Canvas larger 
 */}

This tutorial will show you how to build this dashboard processing all of the USDA Crop Data Layer for a year in realtime:

<iframe 
    style={{
        width: "100%",
        height: "600px",
        minHeight: "500px",
        margin: "0 auto",
        display: "block",
        border: "1px solid #e1e5e9",
        borderRadius: "8px"
    }}
    src="https://unstable.fused.io/canvas/fc_2Q5aNgJzLTagImf6MOdWTG" 
    title="Fused Canvas - Realtime Data Processing Dashboard" 
    frameBorder="0" 
    allowFullScreen
    allow="fullscreen">
</iframe>

### Getting Data

Data comes from [Source Cooperative](https://source.coop/fused/hex), based on the 2024 USDA Crop Data Layer. Fused [repartitioned this into H3 hexagons](https://docs.fused.io/blog/cdl-census-hex) and made it available on [Source Cooperative](https://source.coop/fused/hex) for anyone to access.

We'll visualize the 2024 `hex8` data as a parquet file:

```bash
https://source.coop/fused/hex/release_2025_04_beta/cdl/hex8_2024.parquet
```

This has aggregated the data by `hex8` and has the following columns:

| column | description |
|--------|-------------|
| `value` | USDA Crop Data Layer classification code (e.g., 141, 176, 152, 142, 190) |
| `area` | Area in square meters for each crop type within the hex cell |
| `hex` | H3 hexagon identifier at resolution 8 |

### Processing Data with DuckDB

Before we display the data we want to:
- Remove any nodata (`0`) in cdl
- Calculate the percentage that each crop type makes up of the total area of each hex8 cell 
- Return `lat / lon` coordinates for each hex8 cell to be able to display the data on a map

We can write a simple [Fused UDF](/core-concepts/write) to do this for us

{/* 
TODO: Update with the latest code 
Explain in code:
- Bounds? from US?
*/}

<details>
    <summary>Expand to see code</summary>
    ```python
    @fused.udf
    def udf(bounds: fused.types.Bounds = [-138.80276917029278,-10.699680369962277,-54.08965045331159,65.89861176695153], buffer_multiple: float = 1, hex_res: int = 4):
        crop_type=''
        
        import pandas as pd
        path = "s3://fused-users/fused/asset/CDL_h12k1p1/year=2024/"
        H3_From_To_Pos = fused.load("https://github.com/fusedlabs/fusedudfs/tree/5b022e0/H3_From_To_Pos/")
        df = H3_From_To_Pos.read_hexfile_bounds(bounds=bounds, url=f"{path}overview/hex{hex_res}.parquet", clip=1)
        CDL = fused.load("UDF_CDLs_Tile_Example")
        df = df[df["data"].isin(CDL.crop_type_list(crop_type))]
        import h3.api.basic_int as h3
        df['lat'] = df.hex.map(lambda x:h3.cell_to_latlng(x)[0])
        df['lng'] = df.hex.map(lambda x:h3.cell_to_latlng(x)[1])
        
        print(CDL.crop_stats(df))

        crop_stats = CDL.crop_stats(df)
        name_mapping = crop_stats['name'].to_dict()
        
        con = fused.utils.common.duckdb_connect()

        df = con.sql(
            """
            INSTALL spatial;
            LOAD spatial;
            
            SELECT 
                data,
                lat, 
                lng,
                area, 
                area / (h3_cell_area(hex,'m^2')/100) as pct,
            FROM df
            WHERE data != 0
            """
        ).df()

        df['name'] = df['data'].map(name_mapping)
        

        sample_cols = ['data', 'name', 'lat', 'lng', 'area', 'pct']
        available_cols = [col for col in sample_cols if col in df.columns]
        print(df[available_cols].head(3))
        
        df = df.sort_values('pct', ascending=False)
        df = df.sort_values('data').set_index('data')
        df['pct']=df['pct'].astype(int)
        import h3.api.basic_int as h3
        df['hex']=df.apply(lambda r: h3.latlng_to_cell(r[0],r[1],hex_res),1)
        del df['lat']
        del df['lng']
        del df['name']
        print(df)
        return df.sample(100)
    ```
</details>

{/* TODO: Add link to community UDF once we have it  */}
{/* You can directly see the code for this UDF here */}

This returns directly a dataframe. We can then pass this data directly to another UDF to render this data on a map

### Live filtering on Map

We wrote a custom UDF that takes this data and allows to filter it based on crop type ID:

{/* TODO: Add code here + explain a bit what this does */}

This map is custom to the data we're visualizing but thanks to the [AI Assistant](/workbench/udf-builder/ai-assistant) you can easily adapt this to any data of your choice!

### Building this yourself


