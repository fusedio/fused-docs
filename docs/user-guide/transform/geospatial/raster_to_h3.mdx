---
id: raster-h3
title: Raster to H3
tags: [raster, H3]
sidebar_position: 2
# unlisted: true
---

# Raster to Hexagon

_Transforming raster data into [H3 cells](https://h3geo.org/_

![Raster to H3](/img/user-guide/tranforms/raster_to_hex.jpeg)

## When to use

{/* This needs to be refined a bit more */}

Transforming raster data into H3 cells is useful when you need to:
- Compute statistics across different spatial scales
- Aggregate data across different datasets for any given location

## Code implementation

<details>
<summary>Code Details</summary>

```python showLineNumbers
@fused.udf
def udf(raster_path = 'https://s3.amazonaws.com/elevation-tiles-prod/geotiff/4/4/6.tif', 
        stats_type="mean", 
        h3_res: int = 4,
        height_scale: int = 10,
         color_scale:float=1
    ):
    import pandas as pd
    import rioxarray

    # 2. Read tiff
    da_tiff = rioxarray.open_rasterio(raster_path).squeeze(drop=True).rio.reproject("EPSG:4326")
    df_tiff = da_tiff.to_dataframe("data").reset_index()[["y", "x", "data"]]

    # 3. Hexagonify & aggregate
    df = aggregate_df_hex(
        df_tiff, h3_res, latlng_cols=["y", "x"], stats_type=stats_type
    )
    df["elev_scale"] = height_scale
    df["metric"]=df["metric"]*color_scale
    df = df[df["metric"] > 0]
    print(f"{df.shape=}")
    return df

@fused.cache
def df_to_hex(df, res, latlng_cols=("lat", "lng")):
    utils = fused.load(
        "https://github.com/fusedio/udfs/tree/be3bc93/public/common/"
    ).utils
    qr = f"""
            SELECT h3_latlng_to_cell({latlng_cols[0]}, {latlng_cols[1]}, {res}) AS hex, ARRAY_AGG(data) as agg_data
            FROM df
            group by 1
          --  order by 1
        """
    con = utils.duckdb_connect()
    return con.query(qr).df()


@fused.cache
def aggregate_df_hex(df, res, latlng_cols=("lat", "lng"), stats_type="mean"):
    import pandas as pd

    df = df_to_hex(df, res=res, latlng_cols=latlng_cols)
    if stats_type == "sum":
        fn = lambda x: pd.Series(x).sum()
    elif stats_type == "mean":
        fn = lambda x: pd.Series(x).mean()
    else:
        fn = lambda x: pd.Series(x).mean()
    df["metric"] = df.agg_data.map(fn)
    return df
```

</details>

{/* TODO: Need to make the above a public UDF */}

You can use the above UDF to convert a raster to H3 cells:

```python showLineNumbers
hex_df = udf(
    raster_path="https://s3.amazonaws.com/elevation-tiles-prod/geotiff/4/4/6.tif", 
    stats_type="mean", 
    h3_res=4
)
```

![Raster to hex operation](/img/user-guide/tranforms/raster_to_hex_diagram.png)

## Example application

- [DEM_Tile_Hexify](https://github.com/fusedio/udfs/tree/1bafbfef94c0699222d4a19acee601b0dd6f1228/public/DEM_Tile_Hexify) Public UDF. 
    - This UDF takes a Raster Tile from an open S3 bucket containing an elevation model and converts a tile into H3 on the fly



{/* TODO: This would link to any Example / Blog post that uses this */}