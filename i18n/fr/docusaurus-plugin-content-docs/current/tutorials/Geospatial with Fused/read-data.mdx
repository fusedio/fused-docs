# Lire les données

Exemples courants pour lire des données géospatiales dans Fused.

## Packages Python

### `geopandas`

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/subway_stations.geojson"):
    import geopandas as gpd
    
    return gpd.read_file(path)
```

### `shapely`

```python
@fused.udf
def udf():
    import geopandas as gpd
    from shapely.geometry import Point, Polygon
    
    # Créer des géométries avec shapely
    points = [Point(-122.4, 37.8), Point(-122.3, 37.7)]
    polygon = Polygon([(-122.5, 37.7), (-122.3, 37.7), (-122.3, 37.9), (-122.5, 37.9)])
    
    gdf = gpd.GeoDataFrame(
        {'type': ['point', 'point', 'polygon']},
        geometry=points + [polygon],
        crs=4326
    )
    
    return gdf
```

### `duckdb`

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/housing_2024.parquet"):
    import duckdb
    
    conn = duckdb.connect()
    result = conn.execute(f"""
        SELECT * 
        FROM '{path}'
        WHERE latitude IS NOT NULL
        LIMIT 1000
    """).df()
    
    return result
```

### `rioxarray`

{/* TODO: Données manquantes dans S3 */}

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/elevation.tif"):
    import rioxarray as rxr
    
    # Lire les données raster avec rioxarray
    raster = rxr.open_rasterio(path)
    
    # Convertir en DataFrame pour affichage
    df = raster.to_dataframe().reset_index()
    
    return df.head(1000)
```

### `xarray`

```python
@fused.udf
def udf():
    import xarray as xr
    
    # Télécharger les données NetCDF pour monter le disque pour une lecture correcte
    path = fused.download('s3://fused-sample/demo_data/2025_01_01_ERA5_surface.nc','2025_01_01_ERA5_surface.nc')
    ds = xr.open_dataset(path)
    
    # Convertir en DataFrame
    df = ds.to_dataframe().reset_index()
    
    return df.head(1000)
```

## Formats de tableau (Vecteur)

### GeoJSON (.geojson, .json)

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/table/US_states.geojson"):
    import geopandas as gpd
    
    return gpd.read_file(path)
```

### Shapefile (.shp + .shx, .dbf, .prj)

{/* TODO: Données manquantes dans S3 */}
{/* TODO: Vérifiez également si cela fonctionnerait réellement */}

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/table/US_states_shapefile.shp"):
    import geopandas as gpd
    
    return gpd.read_file(path)
```

### GeoPackage (.gpkg)

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/table/US_states_geopackage.gpkg"):
    import geopandas as gpd
    
    return gpd.read_file(path)
```

### KML/KMZ (.kml, .kmz)

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/table/US_states.kml"):
    import geopandas as gpd
    
    return gpd.read_file(path)
```

{/* ### GML (.gml)

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/parcels.gml"):
    import geopandas as gpd
    
    return gpd.read_file(path)
``` */}

{/* ### File Geodatabase (.gdb)

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/city_data.gdb"):
    import geopandas as gpd
    
    # Lister les couches disponibles
    layers = gpd.list_layers(path)
    print(f"Couches disponibles : {layers}")
    
    # Lire une couche spécifique
    return gpd.read_file(path, layer=0)
``` */}

{/* ### PostGIS (base de données)

```python
@fused.udf
def udf():
    import geopandas as gpd
    from sqlalchemy import create_engine
    
    # Chaîne de connexion (utilisez des variables d'environnement pour les identifiants)
    conn_string = "postgresql://user:password@host:port/database"
    
    engine = create_engine(conn_string)
    gdf = gpd.read_postgis(
        "SELECT * FROM public.my_table LIMIT 1000", 
        engine, 
        geom_col='geometry'
    )
    
    return gdf
``` */}

{/* ### FlatGeobuf (.fgb)

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/roads.fgb"):
    import geopandas as gpd
    
    return gpd.read_file(path)
``` */}

### Parquet (.parquet)

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/buildings.parquet"):
    import geopandas as gpd
    
    return gpd.read_parquet(path)
```

### CSV avec coordonnées (.csv)

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/table/subway_stations.csv"):
    import pandas as pd
    import geopandas as gpd
    from shapely.geometry import Point
    
    # Lire le CSV
    df = pd.read_csv(path)
    
    # Convertir en GeoDataFrame
    gdf = gpd.GeoDataFrame(
        df, 
        geometry=gpd.points_from_xy(df.longitude, df.latitude),
        crs=4326
    )
    
    return gdf
```

### Excel (.xlsx)

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/table/subway_stations.xlsx"):
    import pandas as pd
    import geopandas as gpd
    from shapely.geometry import Point
    
    # Lire le fichier Excel
    df = pd.read_excel(path)
    
    # Convertir en GeoDataFrame si les coordonnées existent
    if 'longitude' in df.columns and 'latitude' in df.columns:
        gdf = gpd.GeoDataFrame(
            df,
            geometry=gpd.points_from_xy(df.longitude, df.latitude),
            crs=4326
        )
        return gdf
    
    return df
```

{/* TODO: Ajouter de nouveau après avoir déplacé ceci */}
{/* ### Tuiles WMS

Pour les tuiles WMS, consultez notre documentation avancée. */}

## Formats de tableau (Raster)

### GeoTIFF (.tif, .tiff)

```python
@fused.udf
def udf(
    path: str = 's3://fused-sample/demo_data/satellite_imagery/wildfires.tiff'
):
    import rasterio

    with rasterio.open(path) as src:
        data = src.read()
        bounds = src.bounds

    return data, bounds
```

### NetCDF (.nc)

```python
@fused.udf
def udf():
    import xarray as xr
    
    # Télécharger pour monter le disque pour une lecture correcte de NetCDF
    path = fused.download('s3://fused-sample/demo_data/climate_data.nc', 'climate_data.nc')
    
    # Ouvrir le jeu de données NetCDF
    ds = xr.open_dataset(path)
    
    return ds.to_dataframe().reset_index().head(1000)
```

{/* ### HDF5 (.h5, .hdf5)

```python
@fused.udf
def udf():
    import h5py
    import numpy as np
    import pandas as pd
    
    # Télécharger le fichier HDF5
    path = fused.download('s3://fused-sample/demo_data/satellite.h5', 'satellite.h5')
    
    with h5py.File(path, 'r') as f:
        # Lister les jeux de données disponibles
        datasets = list(f.keys())
        
        # Lire le premier jeu de données
        data = f[datasets[0]][:]
        
    return pd.DataFrame({'dataset': datasets, 'shape': [str(data.shape)]})
``` */}

{/* ### JPEG2000 (.jp2)

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/landsat.jp2"):
    import rioxarray as rxr
    
    # Lire le fichier JPEG2000
    raster = rxr.open_rasterio(path)
    
    return raster.values, raster.bounds()
``` */}

{/* ### Zarr (.zarr)

```python
@fused.udf
def udf(path: str = "s3://fused-sample/demo_data/climate.zarr"):
    import xarray as xr
    
    # Ouvrir le jeu de données Zarr
    ds = xr.open_zarr(path)
    
    # Convertir en DataFrame
    df = ds.to_dataframe().reset_index()
    
    return df.head(1000)
``` */}

### Catalogue STAC

#### Earth sur AWS

```python
@fused.udf
def udf(
    bounds: fused.types.Bounds = [-77.083, 38.804, -76.969, 38.983],
):
    import odc.stac
    import pystac_client
    import planetary_computer

    odc.stac.configure_s3_access(aws_unsigned=True)
    catalog = pystac_client.Client.open("https://earth-search.aws.element84.com/v1")

    # Chargement du modèle d'élévation
    items = catalog.search(
        collections=["cop-dem-glo-30"], 
        bbox=bounds
    ).item_collection()

    xarray_dataset = odc.stac.load(
        items,
        crs="EPSG:3857",
        bands=["data"],
        resolution=150,
        bbox=bounds,
    ).astype(int)

    return xarray_dataset["data"], bounds
```

#### Microsoft Planetary Computer

```python
@fused.udf
def udf(
    bounds: fused.types.Bounds = [-122.463,37.755,-122.376,37.803],
):
    import odc.stac
    import planetary_computer
    import pystac_client
    
    catalog = pystac_client.Client.open(
        "https://planetarycomputer.microsoft.com/api/stac/v1",
        modifier=planetary_computer.sign_inplace,
    )

    # Chargement du modèle d'élévation
    items = catalog.search(collections=["cop-dem-glo-30"],bbox=bounds).item_collection()
    
    xarray_dataset = odc.stac.load(
        items,
        crs="EPSG:3857",
        bands=["data"],
        resolution=150,
        bbox=bounds,
    ).astype(int)
    
    return xarray_dataset["data"], bounds
``` 